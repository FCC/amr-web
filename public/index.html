<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FCC AMR</title>
    <style>
		.click-callsign {cursor: pointer, color: #aaaaff}
		#text-display {font-size: 12px}
		.available-table {border: solid 1px #000; corner-radius: 5px}
		.available-table td {height: 20px}
		.no {color: #aaa; text-decoration:line-through}
		.yes {color: #4444dd; border: solid 1px #4444dd; cursor: pointer}
		.yes:hover {text-decoration: underline}
		#map {cursor: default}
		#text-display {font-size: 11px;}
		.channel-list-table {border: solid 1px #000;}
		.channel-list-table tr {background-color: #ddd;}
		.channel-list-span {color: #4444dd; cursor: pointer}
		.channel-list-span:hover {text-decoration: underline}
		body {font-size: 12px; font-family: arial; font-color: #ddd; cursor: default}
		
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<link href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" rel="stylesheet">
	<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
	<script src="//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-pip/v0.1.0/leaflet-pip.min.js"></script>
<script>

	var map;
	var contour_json;
	var station_marker;
	var interferingContoursNow;
	var interferingContours_layer;
	var fmContoursNow;
	var fmContours_layer;
	var amStation_layer;
	var amProcessNow;
	var interferenceType;
	var uuid4InterferringContour;
	var channelClicked;
	
	var cursorX;
	var cursorY;
	var clickX = 330;
	var clickY = 400;

	//var host = 'http://localhost:6479';
	var host ="http://amr-web-node-dev01.elasticbeanstalk.com";
	var geo_host = "http://amr-geoserv-tc-dev01.elasticbeanstalk.com";
	var geo_space = "amr";

	var contour_style = {color: "#f00", opacity: 1.0,  fillOpacity: 0.3, fillColor: "#faa", weight: 2};
	var contour_style_fm = {color: "#00f", opacity: 1.0,  fillOpacity: 0.5, fillColor: "#aaf", weight: 2};
	var contour_style_am_station = {color: "#f00", opacity: 1.0,  fillOpacity: 0.0, fillColor: "#aaf", weight: 2};
	
	function createMap() {
 
     L.mapbox.accessToken = 'pk.eyJ1IjoiY29tcHV0ZWNoIiwiYSI6InMyblMya3cifQ.P8yppesHki5qMyxTc2CNLg';
     map = L.mapbox.map('map', 'fcc.k74ed5ge', {
             attributionControl: true,
             maxZoom: 19
         })
         .setView([45, -93], 4);
		 
	 baseStreet = L.mapbox.tileLayer('fcc.k74ed5ge').addTo(map);
     baseSatellite = L.mapbox.tileLayer('fcc.k74d7n0g');
     baseTerrain = L.mapbox.tileLayer('fcc.k74cm3ol');
		 
	 L.control.scale({
         position: 'bottomright'
     }).addTo(map);

     geocoder = L.mapbox.geocoder('mapbox.places-v1');

     layerControl = new L.Control.Layers({
         'Street': baseStreet.addTo(map),
         'Satellite': baseSatellite,
         'Terrain': baseTerrain
     }, {
     }, {
		position: 'topleft'
	 }
	 ).addTo(map);

	  
	 map.on("click", function(e) {
		clickedMap(e);
	});
	  
	}
	
function clickedMap(e) {
	clickX = cursorX;
	clickY = cursorY;
	var lat = Math.round(1000000*e.latlng.lat)/1000000.0;
	var lon = Math.round(1000000*e.latlng.lng)/1000000.0;
	amrProcess(lat, lon);
}
	
function process_rows(rows) {
var arr1 = [];
for (var i = 0; i < rows.length; i++) {
arr1.push(rows[i].channel + "," + rows[i].callsign + "," + rows[i].filenumber + "," + rows[i].facility_id + "," + rows[i].service +  "," + rows[i].class + "," + rows[i].area + "," + rows[i].area1);
}

arr1.sort();
arr2 = [];
var items, entry;
for (i=0; i < arr1.length; i++) {
items = arr1[i].split(",");
items[6] = Math.round(items[6]*10)/10;
items[7] = Math.round(items[7]*10)/10;
entry = {"channel": items[0], "callsign": items[1], "filenumber": items[2], "facility_id": items[3], "service": items[4], "class": items[5], "area": items[6], "area1": items[7]};
arr2.push(entry);
}

return arr2;
}

function makeText(data, interferenceType) {
var str1 = "<table cellpadding=1><tr><td>Channel</td><td>Call</td><td>Service</td><td>fac ID</td><td>Class</td><td>Overlap</td><td>Contour Area</td><td></td></tr>\n";
for (var i = 0; i < data.length; i++) {
str1 += "<tr><td>" + data[i].channel + "</td><td>" + data[i].callsign + "</td><td>" + data[i].service + "</td><td>" + data[i].facility_id + "</td><td>" + data[i].class + "</td><td>" + data[i].area + "</td><td>" + data[i].area1 + "</td><td><span class=\"click-facility_id-class\" value=\"" + data[i].callsign + "," + data[i].class + "\" style=\"cursor: pointer; color: #aaaaff\" >Show Contour(" + data[i].facility_id + "," + data[i].class + "," + interferenceType + ")</span></td></tr>\n";
}
str1 += "</table>";

return str1;
}

function getChannels(data) {
var arr1 = [];
for (var i = 0; i < data.length; i++) {
arr1.push(parseInt(data[i].channel));
}

arr1.sort();

return arr1;
}

function contains(arr, a) {
for (var i = 0; i < arr.length; i++) {
if (a == arr[i]) {return true;}
}
return false;
}

function processData(data) {
amProcessDataNow = data;
var uuid = data.uuid;
uuid4InterferringContour = uuid;

getInterferingContours(uuid);

var data_co = process_rows(data.data_co);
var data_1 = process_rows(data.data_1);
var data_23 = process_rows(data.data_23);

var available_co_1 = [];
for (var i = 0; i <301; i++) {
if (i < 221) {
available_co_1.push(0);
}
else {
available_co_1.push(1);
}
}

var channel_co = getChannels(data_co);
var channel_1 = getChannels(data_1);
var channel_23 = getChannels(data_23);

//remove co-channel
for (i=0; i<channel_co.length; i++) {
available_co_1[channel_co[i]] = 0;
}

//remove 1st adjacent channel
for (i=0; i<channel_1.length; i++) {
available_co_1[channel_1[i]-1] = 0;
if (channel_1[i]+1 <=300) {
available_co_1[channel_1[i]+1] = 0;
}
}

var available_all = available_co_1.slice();
//remove 2nd/3rd adjacent channel
for (i=0; i<channel_23.length; i++) {
available_all[channel_23[i]-3] = 0;
available_all[channel_23[i]-2] = 0;
if (channel_23[i]+3 <=300) {
available_all[channel_23[i]+3] = 0;
}
if (channel_23[i]+2 <=300) {
available_all[channel_23[i]+2] = 0;
}
}


console.log("c 1");
console.log(channel_co);
console.log(channel_1);
console.log(channel_23);

console.log(available_co_1);
console.log(available_all);

var available_all_str = "";
var available_all_arr = [];
for (var i = 0; i < available_all.length; i++) {
	if (available_all[i] == 1) {
		available_all_str += i + ", ";
		available_all_arr.push(i);
	}
}
available_all_str = available_all_str.replace(/, +$/, "");

var available_co_1_str = "";
var available_co_1_arr = [];
for (var i = 0; i < available_co_1.length; i++) {
	if (available_co_1[i] == 1) {
		available_co_1_str += i + ", ";
		available_co_1_arr.push(i);
	}
}
available_co_1_str = available_co_1_str.replace(/, +$/, "");

console.log(available_all_str);
console.log(available_co_1_str);


var text_co = makeText(data_co, "co");
var text_1 = makeText(data_1, "1");
var text_23 = makeText(data_23, "23");

var text_all = "Co-Channel Results:<br>" + text_co + "<p>1st Adjacent Channel Results:<br>" + text_1 +
 "<p>2nd/3rd Adjacent Channel Results:<br>" + text_23 + "<p>";

console.log(text_all);

$("#text-display").html(text_all);

$('.click-facility_id-class').on('click', function(e) {
clickFacilityIDClass(e);
});

//create channel-based output

var fm_info = getFMInfo_co(224, data_co);

var fm_info = getFMInfo_1(224, data_1);

var fm_info = getFMInfo_23(224, data_23);


var channelInfo = {}
for (var c = 221; c < 301; c++) {
fm_info_co = getFMInfo_co(c, data_co);
fm_info_1 = getFMInfo_1(c, data_1);
fm_info_23 = getFMInfo_23(c, data_23);
channelInfo[c] = {"fm_info_co": fm_info_co, "fm_info_1": fm_info_1, "fm_info_23": fm_info_23};


}


//make channel list
var channel_text = "<table class=\"channel-list-table\"><td>Channel</td><td>Co-Channel</td><td>First</td><td>2nd/3rd</td></tr>";
for (c = 221; c < 301; c++) {
//co
text_co = "";
for (var i = 0; i < channelInfo[c].fm_info_co.length; i++) {
var facility_id = channelInfo[c].fm_info_co[i].facility_id;
var filenumber = channelInfo[c].fm_info_co[i].filenumber;
var class0 = channelInfo[c].fm_info_co[i].class;
var id = c + ":" + facility_id + ":" + filenumber + ":" + class0 + ":co";
text_co += "<span id=\"" + id + "\" class=\"channel-list-span\">" + facility_id + "</span>, ";
}
text_co = text_co.replace(/, $/, "");

//1st
text_1 = "";
for (var i = 0; i < channelInfo[c].fm_info_1.length; i++) {
var facility_id = channelInfo[c].fm_info_1[i].facility_id;
var filenumber = channelInfo[c].fm_info_1[i].filenumber;
var class0 = channelInfo[c].fm_info_1[i].class;
var id = c + ":" + facility_id + ":" + filenumber + ":" + class0 + ":1";
text_1 += "<span id=\"" + id + "\" class=\"channel-list-span\">" + facility_id + "</span>, ";
}
text_1 = text_1.replace(/, $/, "");

//2nd/3rd
text_23 = "";
for (var i = 0; i < channelInfo[c].fm_info_23.length; i++) {
var facility_id = channelInfo[c].fm_info_23[i].facility_id;
var filenumber = channelInfo[c].fm_info_23[i].filenumber;
var class0 = channelInfo[c].fm_info_23[i].class;
var id = c + ":" + facility_id + ":" + filenumber + ":" + class0 + ":23";
text_23 += "<span id=\"" + id + "\" class=\"channel-list-span\">" + facility_id + "</span>, ";
}
text_23 = text_23.replace(/, $/, "");


if (text_co + text_1 + text_23 == "") {
	channel_class = "yes";
}
else {
	channel_class = "no";
}

channel_text += "<tr><td><span class=\"" + channel_class + "\">" + c + "</span></td><td>" + text_co + "</td><td>" + text_1 + "</td><td>" + text_23 + "</td></tr>";

}

channel_text += "</table>";

$("#text-display-channel-list").html(channel_text);

$('.channel-list-span').on('click', function(e) {
clickFM(e);
});

$('.yes').on('click', function(e) {
clickAvailableChannel(e);
});




































var available_all_text = makeAvailableTable(available_all);
var available_co_1_text = makeAvailableTable(available_co_1);

available_all_str = available_all_str.replace(",", ", ");
available_co_1_str = available_co_1_str.replace(",", ", ");

var text = "<table width=100%><tr><td align=center width=50% valign=top>" +
 "Available Channels (Co-Channel, 1st, and 2nd/3rd) [" + 
 available_all_arr.length + "]<br>" + available_all_text + "<br>Available Channel List:<br> " +
 available_all_str +  "</td><td align=center width=50% valign=top>" + 
 "Available Channels (Co-Channel and 1st only) [" + available_co_1_arr.length +
 "]<br>" + available_co_1_text + "<br>Available Channel List:<br> " + available_co_1_str +  "</td></tr></table>";

$('#available-table-dispay').html(text);



}

function getFMInfo_co(c, data_co) {
	fm_info = [];
	for (var i = 0; i < data_co.length; i++) {
		if (data_co[i].channel == c) {
			fm_info.push(data_co[i])
		}
	}
	return fm_info;
}

function getFMInfo_1(c, data_1) {
	fm_info = [];
	for (var i = 0; i < data_1.length; i++) {
		var dif = Math.abs(c - data_1[i].channel);
		if (dif == 1) {
			fm_info.push(data_1[i])
		}
	}
	return fm_info;
}

function getFMInfo_23(c, data_23) {
	fm_info = [];
	for (var i = 0; i < data_23.length; i++) {
		var dif = Math.abs(c - data_23[i].channel);
		if (dif == 2 || dif == 3) {
			fm_info.push(data_23[i])
		}
	}
	return fm_info;
}

function clickFM(e) {
e.preventDefault();
var id = e.target.id;
var channel = id.split(":")[0];
var facility_id = id.split(":")[1];
var filenumber = id.split(":")[2];
var class0 = id.split(":")[3];
var interferenceType = id.split(":")[4];

var url = host + "/fmContours/" + facility_id + "/" + filenumber + "/" + class0;

	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
	
			fmContoursNow = data;
			
			if (map.hasLayer(fmContours_layer)) {
				map.removeLayer(fmContours_layer);
			}
			
			fmContours_layer = L.geoJson(data, {
				style: contour_style_fm
			}).addTo(map);
			
			map.fitBounds(fmContours_layer.getBounds());
			
			//make FM contours clickable
			fmContours_layer.on("click", function(e) {
				clickedMap(e);
			});
			
			//re-plot interfering contours

			if (class0 == 'B') {

				dbus = [34, 48, 94];
			}
			else if (class0 == 'B1') {
				dbus = [37, 51, 97];
			}
			else if (contains(['A', 'C', 'C0', 'C1', 'C2', 'C3', 'D', 'L1']), class0) {
				dbus = [40, 54, 100];
			}
			
			console.log(dbus);
			var features = [];
			for (var i = inerferingContoursNow.features.length-1; i >= 0; i--) {
				if (contains(dbus, inerferingContoursNow.features[i].properties.dbu)) {
					features.push(inerferingContoursNow.features[i]);
				}
			}
			var interference_geojson = {"type": "FeatureCollection", "features": features};
			
			if (map.hasLayer(interferingContours_layer)) {
				map.removeLayer(interferingContours_layer);
			}
			interferingContours_layer = L.geoJson(interference_geojson, {
				style: contour_style
			}).addTo(map);
			
			map.fitBounds(interferingContours_layer.getBounds());
			
			//make interfering contours clickable
			interferingContours_layer.on("click", function(e) {
				clickedMap(e);
			});
			
			var info_text = "Channel: " + channel + "<br>";
			info_text += "FM station: Facility_id: " + facility_id + " filenumber: " + filenumber + " Class: " + class0 + " Interference Type: " + interferenceType;

			var type_str = ""
			if (interferenceType == "co") {
				type_str = "co-channel";
			}
			else if (interferenceType == "1") {
				type_str = "first-adjacent channel";
			}
			else if (interferenceType == "23") {
				type_str = "2nd/3rd-adjacent channel";
			}
			
			var channel_fm = fmContoursNow.features[0].properties.channel;
			
			var info_text = "Channel " + channel + " is not available because of " + type_str + " interference with the following FM station:<br>";
			info_text += "<table border=1 cellspacing=0><tr><td>Facility ID</td><td>File Number</td><td>Class</td><td>Channel</td></tr>";
			info_text += "<tr><td>" + facility_id + "</td><td>" + filenumber + "</td><td>" + class0 + "</td><td>" + channel_fm + "</td></tr></table>";
			
			
			$('#info_panel').html(info_text);
			console.log(info_text);
		

		}
			
			
			
			

	});


}

function clickAvailableChannel(e) {

var channel = e.target.innerHTML;
channelClicked = channel;

var url = host + "/fmForAvailableChannel/" + channel + "/" + uuid4InterferringContour;
console.log(url)
	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
			if (data.features.length > 0) {
				if (map.hasLayer(fmContours_layer)) {
					map.removeLayer(fmContours_layer);
				}
				
				fmContours_layer = L.geoJson(data, {
					style: contour_style_fm,
					onEachFeature: onEachFeature_nearbyFM
				}).addTo(map);
				
				var text = "Channel " + channel + ": Nearby FM stations with &#177;3 channel #<p>";
				$('#info_panel').html(text);
			
			}

			
		}
	});
}

function onEachFeature_nearbyFM(feature, layer) {
    layer.on({
        mouseover: overNearbyFM,
        mouseout: outNearbyFM
    });
}

function overNearbyFM(feature, layer) {
	var p = feature.target.feature.properties;
	var text = "Channel " + channelClicked + ": Nearby FM stations with &#177;3 channel #<p>";
	text += "Mouseover Station Info:<table border=1 cellspacing=0><tr><td>Service</td><td>Facility ID</td><td>File Number</td><td>Channel</td><td>Class</td></tr>";
	text += "<tr><td>" + p.service + "</td><td>" + p.facility_id + "</td><td>" + p.filenumber + "</td><td>" + p.channel + "</td><td>" + p.class + "</td></tr></table>";
	$('#info_panel').html(text);
	feature.setStyle(contour_style);
	
console.log(text);
}

function outNearbyFM(feature, layer) {

	var text = "Channel " + channelClicked + ": Nearby FM stations with &#177;3 channel #<p>";
	$('#info_panel').html(text);
}




function makeAvailableTable(a) {

console.log(a)

var text = "<table class=\"available-table\" width=100%>";
var index;
for (var row = 0; row < 8; row++) {
text += "<tr>";
for (var col=0; col<10; col++) {
index = row*10 + col + 221;

if (a[index] == 1) {
	class0 = "yes";
}
else {
	class0 = "no";
}
text += "<td align=center><span class=\"" + class0 + "\">" + index + "</span></td>"
}
text += "<tr>";
}
text += "</table>";

return text;
}


function clickFacilityIDClass(e) {
e.preventDefault();
var fac_class = e.target.innerHTML;
fac_class = fac_class.replace(/^.*\(/, '');
fac_class = fac_class.replace(/\).*$/, '');
var facility_id = fac_class.split(",")[0];
var class0 = fac_class.split(",")[1];
interferenceType = fac_class.split(",")[2];

var url = host + "/fmContours/" + facility_id + "/" + class0;
alert(url);

	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
	
			fmContoursNow = data;
		
			if (map.hasLayer(fmContours_layer)) {
				map.removeLayer(fmContours_layer);
			}
			
			fmContours_layer = L.geoJson(data, {
				style: contour_style_fm
			}).addTo(map);
			
			map.fitBounds(fmContours_layer.getBounds());
			
			//make FM contours clickable
			fmContours_layer.on("click", function(e) {
				clickedMap(e);
			});
			
			//re-plot interfering contours
			var fm_class = fmContoursNow.features[0].properties.class;
			var dbu = 0;
			if (fm_class = 'B') {
				if (interferenceType == "co") {
					dbu = 37;
				}
				else if (interferenceType == "1") {
					dbu = 51;
				}
				else if (interferenceType == "23") {
					dbu = 97;
				}
				dbus = [37, 51, 97];
			}
			else if (fm_class = 'B1') {
				if (interferenceType == "co") {
					dbu = 34;
				}
				else if (interferenceType == "1") {
					dbu = 48;
				}
				else if (interferenceType == "23") {
					dbu = 94;
				}
				dbus = [34, 48, 94];
			}
			else if (contains(['A', 'C', 'C0', 'C1', 'C2', 'C3', 'D', 'L1']), fm_class) {
				if (interferenceType == "co") {
					dbu = 40;
				}
				else if (interferenceType == "1") {
					dbu = 54;
				}
				else if (interferenceType == "23") {
					dbu = 100;
				}
				dbus = [40, 54, 100];
			}
			
			alert(fm_class + ' ' + interferenceType + ' ' + dbu)
			

		}
		
	});

}
	
function getInterferingContours(uuid) {
var url = host + "/interferingContours/" + uuid;

	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
		
		if (data.features.length == 0) {
			alert("No contours available");
			return;
		}
		
		inerferingContoursNow = data;
		
		if (map.hasLayer(interferingContours_layer)) {
			map.removeLayer(interferingContours_layer);
		}
				
		if (map.hasLayer(fmContours_layer)) {
			map.removeLayer(fmContours_layer);
		}
		
		interferingContours_layer = L.geoJson(data, {
			style: contour_style
		}).addTo(map);
		
		map.fitBounds(interferingContours_layer.getBounds());
		
		//make interfering contours clickable
		interferingContours_layer.on("click", function(e) {
			clickedMap(e);
		});

		}
		
	});

	
	
	
}
	
function amrProcess(lat, lon) {

	$('#lat').val(lat);
	$('#lon').val(lon);

	showLoader();
	var url = host + "/amrProcess/" + lat + "/" + lon;

	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
			processData(data);
			hideLoader();
		}
	});
}
	

function showLoader() {
$('#ajax-loader').css({"top": clickY-16, "left": clickX-16});
}

function hideLoader() {
$('#ajax-loader').css({"top": "-200px", "left": "-300px"});
}

	
	
function setupListener() {

$("#latlon-btn").on("click", function(e) {
e.preventDefault();

var lat = $('#lat').val();
var lon = $('#lon').val();

if (lat == "" || lon == "") {
alert("Please enter lat/lon");
return;
}

amrProcess(lat, lon);
});


$("#am-callsign-btn").on("click", function(e) {
e.preventDefault();

var callsign = $('#am-callsign').val().toUpperCase();

if (callsign == "") {
alert("Please call sign");
return;
}

var url = host + "/amContour/" + callsign;

	$.ajax(url, {
        type: "GET",
        url: url,
        dataType: "json",
        success: function(data){
			if (data.features.length > 0) {
				if (map.hasLayer(amStation_layer)) {
					map.removeLayer(amStation_layer);
				}
			
				amStation_layer =  L.geoJson(data, {
				style: contour_style_am_station
				}).addTo(map);
				map.fitBounds(amStation_layer.getBounds());
				amStation_layer.on("click", function(e) {
					clickedMap(e);
				});
			}
		}
	});

});

$(document).on("mousemove", function(e) {
cursorX = e.pageX;
cursorY = e.pageY;
});


}


$(document).ready(function() {
	createMap();
	setupListener();
});


</script>
</head>

<body>
<table>
<tr height=40 bgcolor=#999999><td colspan=2 align=center><span style="font-size: 25px; font-weight: heavy; color: #fff">FCC AMR Channel Finder Tool</span> </td></tr>
<tr>
<td valign="top" width=700>
<div>
<div id="map" style="width: 700px; height: 700px; vertical-align: top">
<div id="info_panel" style="position: absolute; top: 5px; left: 50px; width: 550px; height: 100px; background-color: #fff; border: solid 1px #000; border-radius: 8px; z-index: 999" >
Info Area
</div>
</div>
<p>
<div id="available-table-dispay"></div>
</td>
<td valign="top">
Show AM station contour:<br>
Call sign:<input id="am-callsign"> <button id="am-callsign-btn">go</button>
<p>

Define a point for FM translator:<br>
Latitude:<input id=lat><br> Longitude: <input id=lon><p>
<button id=latlon-btn>Submit</button> <p>

Or click anywhere on the map (and wait for 5 seconds)<p>

<div id="text-display-channel-list" style="height: 512px; border: solid 1px #999; overflow: auto">Data Display Area</div>

<div id="text-display" style="height: 512px; border: solid 1px #999; overflow: auto">Data Display Area</div>


</td>
</tr></table>






<img id="ajax-loader" src="img/ajax-loader.gif" style="position: absolute; top: -200px; left: -300px">

</body>

</html>
